<!-- Imports polymer -->
<link rel="import" href="./polymer/polymer.html">

<!-- Defines element markup -->
<dom-module id="taigi-ruby">
    <template>
        <hruby class="rightangle" rightangle="rightangle">
            <ru span$="{{ji_list.length}}" order="0" class="rightangle" annotation$="{{trs}}">
                <template is="dom-repeat" items="{{ji_list}}">
                    <ru zhuyin diao$="{{item.diao}}" length$="{{item.yin.length}}" form$="{{item.form}}">
                        <rb>{{item.cjk}}</rb>
                        <zhuyin><yin>{{item.yin}}</yin><diao>{{item.diao}}</diao></zhuyin>
                    </ru>
                </template>
            </ru>
        </hruby>
    </template>
</dom-module>
<!-- Registers custom element -->
<script>
// Generated by LiveScript 1.2.0
var Consonants, Vowels, Tones, re, C, V, keyMap;
Consonants = {
  p: 'ㄅ',
  b: 'ㆠ',
  ph: 'ㄆ',
  m: 'ㄇ',
  t: 'ㄉ',
  th: 'ㄊ',
  n: 'ㄋ',
  l: 'ㄌ',
  k: 'ㄍ',
  g: 'ㆣ',
  kh: 'ㄎ',
  ng: 'ㄫ',
  h: 'ㄏ',
  tsi: 'ㄐ',
  ji: 'ㆢ',
  tshi: 'ㄑ',
  si: 'ㄒ',
  ts: 'ㄗ',
  j: 'ㆡ',
  tsh: 'ㄘ',
  s: 'ㄙ'
};
Vowels = {
  a: 'ㄚ',
  an: 'ㄢ',
  ang: 'ㄤ',
  ann: 'ㆩ',
  oo: 'ㆦ',
  onn: 'ㆧ',
  o: 'ㄜ',
  e: 'ㆤ',
  enn: 'ㆥ',
  ai: 'ㄞ',
  ainn: 'ㆮ',
  au: 'ㄠ',
  aunn: 'ㆯ',
  am: 'ㆰ',
  om: 'ㆱ',
  m: 'ㆬ',
  ong: 'ㆲ',
  ng: 'ㆭ',
  i: 'ㄧ',
  inn: 'ㆪ',
  u: 'ㄨ',
  unn: 'ㆫ',
  ing: 'ㄧㄥ',
  'in': 'ㄧㄣ',
  un: 'ㄨㄣ'
};
Tones = {
  p: 'ㆴ',
  t: 'ㆵ',
  k: 'ㆶ',
  h: 'ㆷ',
  p$: "ㆴ\u0358",
  t$: "ㆵ\u0358",
  k$: "ㆶ\u0358",
  h$: "ㆷ\u0358",
  "\u0300": '˪',
  "\u0301": 'ˋ',
  "\u0302": 'ˊ',
  "\u0304": '˫',
  "\u030d": '$'
};
re = function(it){
  var k;
  return (function(){
    var results$ = [];
    for (k in it) {
      results$.push(k);
    }
    return results$;
  }()).sort(function(x, y){
    return y.length - x.length;
  }).join('|');
};
C = re(Consonants);
V = re(Vowels);
function trs2bpmf(trs){
  return trs.replace(/[A-Za-z\u0300-\u030d]+/g, function(it){
    var tone;
    tone = '';
    it = it.toLowerCase();
    it = it.replace(/([\u0300-\u0302\u0304\u030d])/, function(it){
      tone = Tones[it];
      return '';
    });
    it = it.replace(/^(tsh?|[sj])i/, '$1ii');
    it = it.replace(/ok$/, 'ook');
    it = it.replace(RegExp('^(' + C + ')((?:' + V + ')+[ptkh]?)$'), function(){
      return Consonants[arguments[1]] + arguments[2];
    });
    it = it.replace(/[ptkh]$/, function(it){
      tone = Tones[it + tone];
      return '';
    });
    it = it.replace(RegExp('(' + V + ')', 'g'), function(it){
      return Vowels[it];
    });
    return it + (tone || '\uFFFD');
  }).replace(/[- ]/g, '').replace(/\uFFFD/g, ' ').replace(/[.?!,] ?/g, '');
}

var UNICODE, rZyS, rZyJ, rZyY, rZyD, TYPESET;
UNICODE = {
  zhuyin: {
    base: '[\u3105-\u312D\u31A0-\u31BA]',
    initial: '[\u3105-\u3119\u312A-\u312C\u31A0-\u31A3]',
    medial: '[\u3127-\u3129]',
    final: '[\u311A-\u3129\u312D\u31A4-\u31B3\u31B8-\u31BA]',
    tone: '[\u02D9\u02CA\u02C5\u02C7\u02CB\u02EA\u02EB]',
    ruyun: '[\u31B4-\u31B7][\u0358\u030d]?'
  }
};
rZyS = UNICODE.zhuyin.initial;
rZyJ = UNICODE.zhuyin.medial;
rZyY = UNICODE.zhuyin.final;
rZyD = UNICODE.zhuyin.tone + '|' + UNICODE.zhuyin.ruyun;
TYPESET = {
  zhuyin: {
    form: new RegExp('^\u02D9?(' + rZyS + ')?(' + rZyJ + ')?(' + rZyY + ')?(' + rZyD + ')?$'),
    diao: new RegExp('(' + rZyD + ')', 'g')
  }
};


Polymer({
    is: 'taigi-ruby',
    properties: {
        trs: String,
        cjk: String,
    },
    ready: function() {
        console.log(this)
        this.ji_list = [{cjk:"阮", yin:"ㆣㄨㄢ", diao:"ˋ", form: 'SJY'}]
        this.ji_list =  this.TRStoZHY(this.trs, this.cjk)
        console.log(trs2bpmf(this.trs))
    },
    TRStoZHY: function(trs,cjk) {
        trs = trs.normalize('NFD')
        syls = trs.split(/[ -]/)
        result =  syls.map(function(syl, i) {
            zhuyin = trs2bpmf(syl)
            last = zhuyin[zhuyin.length -1]
            if (["ㆴ", "ㆵ", "ㆶ", "ㆷ", "ㆴ͘", "ㆵ͘", "ㆶ͘", "ㆷ͘", "˪", "ˋ", "ˊ", "˫"].indexOf(last) != -1) {
                diao = zhuyin[zhuyin.length -1]
                yin = zhuyin.slice(0,zhuyin.length -1)
                console.log("true")
            }
            else {
                yin = zhuyin
                diao = ""
                console.log("false")
            }
            form = zhuyin.replace(TYPESET.zhuyin.form, function(s, j, y){
                return [s ? 'S' : null, j ? 'J' : null, y ? 'Y' : null].join('');
            });

            return {cjk:cjk[i], yin:yin, diao:diao, form:form}
        })
      return result
      /*return [
            {cjk:"圖", yin:"ㄉㆦ", diao:'ˊ', form:'SY'},
            {cjk:"書", yin:"ㄙㄨ", diao:'', form:'SY'},
            {cjk:"館", yin:"ㄍㄨㄢ", diao:'ˋ', form:'SJY'} ]*/
   }
});
</script>
